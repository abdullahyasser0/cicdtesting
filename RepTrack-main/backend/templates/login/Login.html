<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Welcome to Reptrack</title>
    <!-- Link to Supabase JS SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.0.0/dist/umd/supabase.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js"></script>

  </head>


<style>
    .login-container {
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .login-wrapper {
      display: flex;
      flex-direction: column;
      position: relative;
      min-height: 950px;
      width: 100%;
      overflow: hidden;
      align-items: start;
      padding: 119px 80px 59px;
    }
    
    .background-image {
      position: absolute;
      inset: 0;
      height: 100%;
      width: 100%;
      object-fit: cover;
      object-position: center;
    }
    
    .login-form-container {
      position: relative;
      display: flex;
      width: 450px;
      max-width: 100%;
      flex-direction: column;
    }
    
    .welcome-text {
      color: rgba(26, 19, 99, 1);
      text-align: center;
      align-self: center;
      font: 700 24px Poppins, sans-serif;
    }
    
    .form-group {
      margin: 45px 0 0 19px;
    }
    
    .form-label {
      color: rgba(105, 92, 92, 1);
      font: 400 14px Poppins, sans-serif;
    }
    
    .form-input {
      border-radius: 10px;
      background-color: rgba(255, 255, 255, 0.08);
      margin-top: 17px;
      color: rgba(0, 0, 0, 0.7);
      padding: 14px;
      font: 400 16px Poppins, sans-serif;
      border: 1px solid rgba(0, 0, 0, 0.4);
      width: 100%;
    }
    
    .password-input-wrapper {
      position: relative;
      width: 100%;
    }
    
    .password-toggle {
      position: absolute;
      right: 18px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      padding: 0;
      cursor: pointer;
    }
    
    .remember-forgot-wrapper {
      display: flex;
      margin-top: 25px;
      justify-content: space-between;
      align-items: center;
      font-size: 15px;
    }
    
    .remember-me {
      display: flex;
      align-items: center;
      gap: 10px;
      font: 600 15px Manrope, sans-serif;
      color: rgba(0, 12, 20, 1);
    }
    
    .forgot-password {
      color: rgba(232, 105, 105, 1);
      font: 500 15px Poppins, sans-serif;
      text-decoration: none;
    }
    
    .login-button {
      border-radius: 5px;
      background-color: rgba(26, 19, 99, 1);
      color: rgba(255, 255, 255, 0.9);
      font: 600 16px Poppins, sans-serif;
      padding: 11px 70px;
      border: none;
      cursor: pointer;
      width: 100%;
      margin-top: 35px;
    }
    
    .divider {
      text-align: center;
      margin: 32px 0;
      position: relative;
    }
    
    .divider-text {
      color: rgba(0, 0, 0, 0.8);
      font: 400 18px Poppins, sans-serif;
      background: #fff;
      padding: 0 10px;
      position: relative;
      z-index: 1;
    }
    
    .divider-line {
      border-top: 1px solid rgba(0, 0, 0, 0.5);
      position: absolute;
      top: 50%;
      width: 164px;
    }
    
    .divider-line-left {
      left: 0;
    }
    
    .divider-line-right {
      right: 0;
    }
    
    .social-login-button {
      display: flex;
      align-items: center;
      gap: 58px;
      border-radius: 10px;
      padding: 12px;
      margin-top: 32px;
      width: 100%;
      border: none;
      cursor: pointer;
      font: 600 16px Poppins, sans-serif;
    }
    
    .facebook-button {
      background-color: rgba(24, 119, 242, 1);
      color: rgba(255, 255, 255, 0.9);
    }
    
    .google-button {
      background-color: rgba(255, 255, 255, 0.02);
      color: rgba(0, 0, 0, 0.6);
      border: 1px solid rgba(0, 0, 0, 0.4);
    }
    
    .x-button {
      background-color: rgba(0, 0, 0, 1);
      color: rgba(255, 255, 255, 0.9);
    }
    
    .signup-prompt {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
      margin-top: 35px;
      font: 600 16px Manrope, sans-serif;
    }
    
    .signup-link {
      color: rgba(22, 0, 98, 1);
      text-decoration: none;
    }
    
    .visually-hidden {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      border: 0;
    }
    
    @media (max-width: 991px) {
      .login-wrapper {
        max-width: 100%;
        padding: 100px 20px 0;
      }
      
      .form-group {
        margin-left: 10px;
      }
      
      .form-input {
        max-width: 100%;
      }
      
      .login-button {
        padding: 11px 20px;
      }
      
      .social-login-button {
        max-width: 100%;
      }
      
      .signup-prompt {
        margin-top: 40px;
      }
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.5);
    }

    .modal-content {
      background-color: #fff;
      margin: 15% auto;
      padding: 20px;
      border-radius: 8px;
      width: 100%;
      max-width: 400px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      text-align: center;
    }

    .modal-content span.close {
      color: #aaa;
      float: right;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
    }

    .modal-content form {
      margin-top: 20px;
    }

    .modal-content form label {
      display: block;
      margin-bottom: 10px;
      font-weight: bold;
      font-size: 16px;
    }

    .modal-content form input[type="email"], .modal-content form input[type="text"] {
      padding: 10px;
      margin-bottom: 20px;
      border: 1px solid #ccc;
      border-radius: 4px;
      width: calc(100% - 22px);
    }

    .modal-content form button {
      background-color: #4CAF50;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
    }

    .modal-content form button:hover {
      background-color: #45a049;
    }

    .modal-content p.error-message {
      color: red;
      font-size: 14px;
      margin: 10px 0 0 0;
    }


</style>

<div class="login-container">
  <div class="login-wrapper">
    <img loading="lazy" src="https://cdn.builder.io/api/v1/image/assets/TEMP/73859a4080c54497641fa264d99c94f756e5713418b21e17db00286aa16c3403?placeholderIfAbsent=true&apiKey=e9d236d8c0c94057ac283d5229bb03b9" class="background-image" alt="" />
    <form class="login-form-container" id="loginForm">
      {% csrf_token %}
      <h1 class="welcome-text">Hi, Welcome Back! ðŸ‘‹</h1>
      
      <div class="form-group">
        <label for="email" class="form-label">Email</label>
        <input type="email" id="email" class="form-input" placeholder="Enter your Email" required />
      </div>

      <div class="form-group">
        <label for="password" class="form-label">Password</label>
        <div class="password-input-wrapper">
          <input type="password" id="password" class="form-input" placeholder="Enter Your Password" required />
          <button type="button" class="password-toggle" aria-label="Toggle password visibility" onclick="togglePasswordVisibility()">
            <img loading="lazy" src="https://cdn.builder.io/api/v1/image/assets/TEMP/482a3c01cbff113ec02eb181752319c28b143aad3dd3547789a587c4e45bbfe3?placeholderIfAbsent=true&apiKey=e9d236d8c0c94057ac283d5229bb03b9" style="margin-top: 15px;" alt="Eye icon" width="25" height="25" />
          </button>
        </div>
      </div>

      <div class="remember-forgot-wrapper">
        <label class="remember-me">
          <input type="checkbox" class="visually-hidden" />
          <span class="checkbox-custom"></span>
          Remember Me
        </label>
        <a href="#" class="forgot-password" onclick="openModal('forgotPasswordModal')">Forgot Password?</a>
      </div>

      <button type="submit" class="login-button">Login</button>

      <div class="divider">
        <span class="divider-text">Or With</span>
        <div class="divider-line divider-line-left"></div>
        <div class="divider-line divider-line-right"></div>
      </div>

      <button id="google-login-btn" type="button" class="social-login-button google-button">
        <img loading="lazy" src="https://cdn.builder.io/api/v1/image/assets/TEMP/ae4273c5a573ab7930804958d0b59c0432b59af31c59f89db1b79b981a4d58ab?placeholderIfAbsent=true&apiKey=e9d236d8c0c94057ac283d5229bb03b9" alt="" width="37" height="37" />
        Login with Google
      </button>

      <div class="signup-prompt">
        <span>Don't have an account?</span>
        <a href="{% url 'signup' %}" class="signup-link">Sign up here</a>
      </div>
    </form>
  </div>
</div>














<!-- Forgot Password Modal -->
<div id="forgotPasswordModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal('forgotPasswordModal')">&times;</span>
    <h2>Forgot Password</h2>
    <p>Enter your email and we'll send you an OTP to reset your password.</p>
    <form id="forgotPasswordForm">
      <label for="forgotEmail">Email:</label>
      <input type="email" id="forgotEmail" required>
      <div id="otpInputContainer" style="display: none; margin-top: 20px;">
        <label for="otp">Enter OTP:</label>
        <input type="text" id="otp" placeholder="Enter OTP" required>
      </div>
      <button type="button" id="sendOtpButton" onclick="sendOtpHandler()">Send OTP</button>
    </form>
  </div>
</div>

<div id="resetPasswordModal" class="modal">
  <div class="modal-content">
      <span class="close" onclick="closeModal('resetPasswordModal')">&times;</span>
      <h2>Reset Password</h2>
      <form id="resetPasswordForm">
          <!-- Hidden Fields to Store Email and OTP -->
          <input type="hidden" id="resetEmail" value="">
          <input type="hidden" id="resetOtp" value="">
          
          <label for="newPassword">New Password:</label>
          <input type="password" id="newPassword" required>
          <label for="confirmPassword">Confirm Password:</label>
          <input type="password" id="confirmPassword" required>
          <p id="passwordMessage" class="error-message"></p>
          <button type="button" onclick="resetPasswordHandler()">Reset</button>
      </form>
  </div>
</div>

<script> 
  // Function to open a modal
function openModal(modalId) {
  document.getElementById(modalId).style.display = 'block';
}

// Function to close a modal
function closeModal(modalId) {
  document.getElementById(modalId).style.display = 'none';
  // Reset forms and messages when closing
  if (modalId === 'forgotPasswordModal') {
      document.getElementById('forgotPasswordForm').reset();
      document.getElementById('otpInputContainer').style.display = 'none';
      const sendOtpButton = document.getElementById('sendOtpButton');
      sendOtpButton.textContent = 'Send OTP';
      sendOtpButton.onclick = sendOtpHandler;
  } else if (modalId === 'resetPasswordModal') {
      document.getElementById('resetPasswordForm').reset();
      document.getElementById('passwordMessage').textContent = '';
  }
}

// Function to handle sending OTP
function sendOtpHandler() {
  const email = document.getElementById('forgotEmail').value;

  if (email === '') {
      alert('Please enter your email address.');
      return;
  }

  // Send OTP to backend
  fetch('/forget-password/', { // Ensure this URL is correctly mapped in Django
      method: 'POST',
      headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken'),
      },
      body: JSON.stringify({ email: email }),
  })
  .then(response => response.json())
  .then(data => {
      if (data.success) {
          alert('OTP has been sent to ' + email +' please check your email ');
          // Show the OTP input container
          const otpInputContainer = document.getElementById('otpInputContainer');
          otpInputContainer.style.display = 'block'; // Make OTP box visible

          // Update the button text to "Verify OTP"
          const sendOtpButton = document.getElementById('sendOtpButton');
          sendOtpButton.textContent = 'Verify OTP';
          sendOtpButton.onclick = verifyOtpHandler;
      } else {
          // To prevent email enumeration, show generic message
          alert('user with this email does not exist, you can signup');
          // Optionally, hide the modal
          closeModal('forgotPasswordModal');
          window.location.href = '/';

      }
  })
  .catch(error => {
      console.error('Error:', error);
      alert("An error occurred while sending OTP. Please try again.");
  });
}

// Function to handle verifying OTP
function verifyOtpHandler() {
  const email = document.getElementById('forgotEmail').value;
  const otp = document.getElementById('otp').value;
  
  if (otp === '') {
      alert('Please enter the OTP.');
      return;
  }

  // Verify OTP with backend
  fetch('/verify-otp/', { // Ensure this URL is correctly mapped in Django
      method: 'POST',
      headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken'),
      },
      body: JSON.stringify({ email: email, otp: otp }),
  })
  .then(response => response.json())
  .then(data => {
      if (data.success) {
          alert('OTP verified successfully!');
          closeModal('forgotPasswordModal'); // Close the modal after verification
          // Open the reset password modal
          openModal('resetPasswordModal');
          
          // Populate the hidden fields in resetPasswordForm
          document.getElementById('resetEmail').value = email;
          document.getElementById('resetOtp').value = otp;
      } else {
          // Show error message
          alert(data.error);
      }
  })
  .catch(error => {
      console.error('Error:', error);
      alert("An error occurred while verifying OTP. Please try again.");
  });
}

// Function to handle resetting the password
function resetPasswordHandler() {
  const email = document.getElementById('resetEmail').value; // Updated to get from hidden field
  const otp = document.getElementById('resetOtp').value; // Updated to get from hidden field
  const newPassword = document.getElementById('newPassword').value;
  const confirmPassword = document.getElementById('confirmPassword').value;
  const passwordMessage = document.getElementById('passwordMessage');

  if (!newPassword || !confirmPassword) {
      passwordMessage.style.color = 'red';
      passwordMessage.textContent = 'Please fill in both fields.';
      return;
  }

  if (newPassword.length < 8) {
      passwordMessage.style.color = 'red';
      passwordMessage.textContent = 'Password must be at least 8 characters long.';
      return;
  }

  if (newPassword !== confirmPassword) {
      passwordMessage.style.color = 'red';
      passwordMessage.textContent = 'Passwords do not match.';
      return;
  }

  // Reset password via backend
  fetch('/reset-password/', { // Ensure this URL is correctly mapped in Django
      method: 'POST',
      headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken'),
      },
      body: JSON.stringify({
          email: email,
          otp: otp,
          new_password: newPassword,
          confirm_password: confirmPassword,
      }),
  })
  .then(response => response.json())
  .then(data => {
      if (data.success) {
          passwordMessage.style.color = 'green';
          passwordMessage.textContent = 'Password successfully reset!';
          // Optionally, close the modal after a short delay
          setTimeout(() => {
              closeModal('resetPasswordModal');
              alert('Your password has been reset. Please log in with your new password.');
              window.location.href = '/signup/login/'; // Redirect to login page
          }, 2000);
      } else {
          passwordMessage.style.color = 'red';
          passwordMessage.textContent = data.error;
      }
  })
  .catch(error => {
      console.error('Error:', error);
      passwordMessage.style.color = 'red';
      passwordMessage.textContent = 'An error occurred while resetting your password.';
  });
}

</script>




































<script>
  // Function to toggle password visibility
  function togglePasswordVisibility() {
    const passwordField = document.getElementById('password');
    const passwordToggleButton = document.querySelector('.password-toggle img');
    
    if (passwordField.type === 'password') {
      passwordField.type = 'text';
      passwordToggleButton.src = 'https://cdn.builder.io/api/v1/image/assets/TEMP/576cce65a6f5a54005d0c024121ec174dd368897178c9898196255f404df8f5f?placeholderIfAbsent=true&apiKey=e9d236d8c0c94057ac283d5229bb03b9'; // Eye Opened icon
    } else {
      passwordField.type = 'password';
      passwordToggleButton.src = "https://cdn.builder.io/api/v1/image/assets/TEMP/482a3c01cbff113ec02eb181752319c28b143aad3dd3547789a587c4e45bbfe3?placeholderIfAbsent=true&apiKey=e9d236d8c0c94057ac283d5229bb03b9";
    }
  }

  // Function to fetch CSRF token
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

// Function to handle login form submission
document.getElementById('loginForm').addEventListener('submit', function(event) {
    event.preventDefault(); // Prevent form's default submission behavior

    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;

    const loginUrl = "{% url 'loginform' %}"; // Django's URL for login processing
    const loginData = {
      email: email,
      password: password,
    };


  
  fetch(loginUrl, {
    method: 'POST',
    headers: {

        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken'),
      },
      body: JSON.stringify(loginData),
    })
    .then(response => {
      if (response.ok) {
        // Redirect to profile on successful login
        //window.location.href = "/profile/information.html";
        
      } else if (response.status === 401) {
        // Unauthorized error
        alert("Invalid email or password. Please try again.");
      } else {
        // General error
        alert("An error occurred. Please try again.");
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert("An error occurred. Please try again.");
    });
  });

  // Function to check session and redirect accordingly
  function checkSession() {
    const session = document.cookie.includes("session_id="); 

    if (session) {
      console.log("Session exists. Redirecting to profile page...");
      window.location.href = '/profile/information.html'; 
    }
  }

  // Check session on page load
  window.onload = function() {
    checkSession();
  };

  document.addEventListener("DOMContentLoaded", function() {
            try {
                console.log("Initializing Supabase client...");

                // Initialize Supabase with your project URL and public API key
                const supabaseUrl = 'https://sodghnhticinsggmbber.supabase.co';  // Replace with your Supabase URL
                const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNvZGdobmh0aWNpbnNnZ21iYmVyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzIyODY5MzMsImV4cCI6MjA0Nzg2MjkzM30.dCfS98X9PFoZpBohhf0UdgSvvcwByOlAPki7-BPlExg';  // Replace with your public anon key from the Supabase dashboard
                
                console.log('Supabase URL:', supabaseUrl);  // Log URL to ensure it's correct
                console.log('Supabase Key:', supabaseKey);  // Be cautious, do not expose the key in production

                // Check if supabase object exists before calling createClient
                if (typeof supabase === 'undefined') {
                    console.error('Supabase SDK is not loaded correctly.');
                    return;
                }

                // Create the Supabase client object
                const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

                console.log('Supabase client successfully created:', supabaseClient);

                // Check if supabase.auth is available
                if (supabaseClient && supabaseClient.auth) {
                    console.log('Supabase auth is available:', supabaseClient.auth);
                } else {
                    console.error('Supabase auth object is not available. Something went wrong with the client creation.');
                }

                // Optionally, you can also check the version of the Supabase SDK for debugging purposes
                console.log('Supabase SDK version:', supabase.VERSION);

                // Google login button logic
      document.getElementById("google-login-btn").onclick = async () => {
      try {
        console.log("Google login initiated...");

        // Trigger Google login via Supabase OAuth
        const { user, session, error } = await supabaseClient.auth.signInWithOAuth({
          provider: "google",
          options: {
        redirectTo: window.location.origin, // Ensure proper redirect after login
        },
        });

        if (error) {
          console.error("Error during Google login:", error.message);
          alert("Google login failed. Please try again.");
          return;
        }
      } catch (error) {
        console.error("Error during Google login:", error);
        alert("An error occurred. Please try again.");
      }
    };
  } catch (error) {
    console.error("Error during Supabase client initialization:", error);
  }
});

supabaseClient.auth.onAuthStateChange(async (event, session) => {
        console.log("Auth state changed:", event, session);

        if (event === "SIGNED_IN" && session) {
            console.log("User signed in successfully. Sending token to backend...");

            const accessToken = session.access_token;

            try {
                // Send the token to the Django backend
                const response = await fetch("/verify-token/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": getCookie("csrftoken"), // CSRF token for Django
                    },
                    body: JSON.stringify({ token: accessToken }),
                });

                if (response.ok) {
                    console.log("Backend verification successful.");
                    window.location.href = "/dashboard/"; // Redirect to your protected page
                } else {
                    console.error("Backend verification failed:", await response.json());
                    alert("Authentication failed on the server.");
                }
            } catch (error) {
                console.error("Error sending token to backend:", error);
                alert("An error occurred while communicating with the server.");
            }
        } else if (event === "SIGNED_OUT") {
            console.log("User signed out.");
        }
    });


</script>